<script>
  fetch('/.netlify/functions/fetchAirtable')
    .then(response => response.json())
    .then(data => {
      console.log("Response Data:", data);

      // ✅ Load Mapbox API key from Netlify response
      mapboxgl.accessToken = data.mapboxKey;

      // ✅ Initialize Map
      const map = new mapboxgl.Map({
        container: 'map',
        style: 'mapbox://styles/mapbox/streets-v12',
        center: [-74.0060, 40.7128],
        zoom: 12
      });

      const records = data.airtableData.records || [];
      records.forEach(record => {
        if (record.fields.Locations) {
          const locations = record.fields.Locations.split(' | ');
          locations.forEach(location => {
            const [name, url] = location.split(', ');
            let coords;

            if (name.includes("Joe’s Pizza")) coords = [-74.0029, 40.7317];
            else if (name.includes("Sally’s Burgers")) coords = [-73.9614, 40.7658];
            else coords = [-74.0060, 40.7128];

            new mapboxgl.Marker()
              .setLngLat(coords)
              .setPopup(new mapboxgl.Popup().setHTML(`<h3>${name}</h3><p><a href="${url}" target="_blank">More Info</a></p>`))
              .addTo(map);
          });
        }
      });
    })
    .catch(error => console.error("Error fetching data:", error));
</script>